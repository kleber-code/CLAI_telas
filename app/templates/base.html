{% from "macros/pagination_macros.html" import render_pagination %}
<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="light"{% block html_attribs %}{% endblock %}>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="CLAI - Plataforma de Gestão Educacional">
    <meta name="theme-color" content="#0d6efd">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/main.min.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}" media="print">
    <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
    <title>{% if title %}{{ title }} - {% endif %}CLAI | Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/pace-js@latest/pace.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@latest/pace-theme-default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

    <script src="{{ url_for('static', filename='js/cpf_formatter.js') }}"></script>

    {% block head_extra %}{% endblock %}
</head>

<body class="d-flex" id="wrapper"{% block body_attribs %}{% endblock %}>
    {% block body %}
    <div id="sidebar-wrapper">
        <div class="sidebar-heading d-flex justify-content-between align-items-center py-4 px-3">
            <div class="fw-bold fs-4 text-primary tracking-tight">
                {{ config.APP_BASE_NAME }}<span class="text-body text-opacity-50">{{ config.APP_SUFFIX }}</span>
            </div>
            <button class="btn btn-link text-secondary" id="sidebar-close">
                <i class="bi bi-x-lg fs-4"></i>
            </button>
        </div>

        <div class="list-group list-group-flush my-3">
            <small class="text-uppercase text-muted fw-bold px-4 mb-2" style="font-size: 0.75rem;">Menu
                Principal</small>

            <a href="{{ url_for('main.dashboard') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.dashboard' %}active{% endif %}">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard
            </a>

            {% if current_user.is_authenticated and current_user.role == 'admin' %}
            <a href="{{ url_for('main.list_users') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.list_users' %}active{% endif %}">
                <i class="bi bi-people me-2"></i>Profissionais
            </a>
            {% endif %}

            <a href="{{ url_for('main.list_students') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.list_students' %}active{% endif %}">
                <i class="bi bi-mortarboard me-2"></i>Alunos
            </a>

            <small class="text-uppercase text-muted fw-bold px-4 mb-2 mt-3"
                style="font-size: 0.75rem;">Ferramentas</small>

            <a href="{{ url_for('main.calendar') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.calendar' %}active{% endif %}">
                <i class="bi bi-calendar4-week me-2"></i>Calendário
            </a>
            <a href="{{ url_for('main.mark_attendance') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.mark_attendance' %}active{% endif %}">
                <i class="bi bi-check-square me-2"></i>Frequência
            </a>
            <a href="{{ url_for('main.list_general_reports') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.list_general_reports' %}active{% endif %}">
                <i class="bi bi-graph-up me-2"></i>Relatórios Gerais
            </a>
            <a href="{{ url_for('main.list_daily_reports') }}"
                class="list-group-item list-group-item-action {% if 'daily_report' in request.endpoint %}active{% endif %}">
                <i class="bi bi-journal-text me-2"></i>Relatórios Diários
            </a>
            <a href="#" id="installButton" class="list-group-item list-group-item-action d-none" title="Instalar Aplicativo">
                <i class="bi bi-cloud-download me-2"></i>Instalar App
            </a>
        </div>

        <div class="mt-auto p-3 border-top">
            <a href="{{ url_for('main.logout') }}"
                class="d-flex align-items-center text-decoration-none text-danger px-3 py-2 rounded hover-bg-light">
                <i class="bi bi-box-arrow-right me-2"></i>
                <span class="fw-medium">Sair do Sistema</span>
            </a>
        </div>
    </div>
    <div id="page-content-wrapper">
        <nav class="navbar navbar-expand-lg main-navbar px-4">
            <div class="d-flex align-items-center w-100">
                <button class="btn btn-link text-body p-0 me-3" id="menu-toggle">
                    <i class="bi bi-list fs-4"></i>
                </button>

                <h1 class="h5 m-0 fw-semibold text-body">{% block page_heading %}Visão Geral{% endblock %}</h1>

                <div class="ms-auto d-flex align-items-center gap-3">
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('main.list_notifications') }}" class="btn btn-link text-body-secondary p-0 position-relative" title="Notificações">
                        <i class="bi bi-bell"></i>
                        <span id="unread-notifications-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                            0
                            <span class="visually-hidden">unread notifications</span>
                        </span>
                    </a>
                    {% endif %}
                    <button class="btn btn-link text-body-secondary p-0" id="theme-toggle" title="Alternar Tema">
                        <i class="bi bi-moon-stars"></i>
                    </button>

                    <div class="dropdown">
                        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                                style="width: 32px; height: 32px;">
                                {% if current_user.is_authenticated %}
                                {{ current_user.name[0] | upper }}
                                {% else %}
                                <i class="bi bi-person"></i> {# Placeholder for unauthenticated user #}
                                {% endif %}
                            </div>
                            <div class="d-none d-md-block">
                                {% if current_user.is_authenticated %}
                                <span class="fw-medium text-body d-block" style="line-height: 1;">{{
                                    current_user.name }}</span>
                                <small class="text-muted" style="font-size: 0.75rem;">{{ current_user.role |
                                    capitalize }}</small>
                                {% else %}
                                <span class="fw-medium text-body d-block" style="line-height: 1;">Convidado</span>
                                <small class="text-muted" style="font-size: 0.75rem;">Não Autenticado</small>
                                {% endif %}
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                            {% if current_user.is_authenticated %}
                            <li><a class="dropdown-item" href="{{ url_for('main.profile') }}"><i
                                        class="bi bi-person-circle me-2"></i>Meu Perfil</a>
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('main.change_password') }}"><i
                                        class="bi bi-key me-2"></i>Alterar Senha</a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="{{ url_for('main.logout') }}"><i
                                        class="bi bi-box-arrow-right me-2"></i>Sair</a>
                            </li>
                            {% else %}
                            <li><a class="dropdown-item" href="{{ url_for('main.login') }}"><i
                                        class="bi bi-box-arrow-in-right me-2"></i>Entrar</a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="container-fluid mt-3">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <main class="container-fluid px-4 py-4 animate__animated animate__fadeIn">
            {% block content %}
            <div class="alert alert-light border shadow-sm" role="alert">
                <h4 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Bem-vindo ao CLAI</h4>
                <p class="mb-0 text-muted">Selecione uma opção no menu lateral para começar.</p>
            </div>
            {% endblock %}

            {% block pagination %}
            {% if paginator %}
                {{ render_pagination(paginator) }}
            {% endif %}
            {% endblock %}
        </main>
    </div>
    {% endblock %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const wrapper = document.getElementById("wrapper");
            const toggleButton = document.getElementById("menu-toggle");
            const closeButton = document.getElementById("sidebar-close");
            const themeToggle = document.getElementById("theme-toggle");

            // LOG DE DEBUG: Vamos ver se o JS achou os elementos
            console.log("Wrapper encontrado?", wrapper);
            console.log("Botão Abrir encontrado?", toggleButton);
            console.log("Botão Fechar encontrado?", closeButton);

            function toggleMenu(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation(); // Garante que o clique não "vaze"
                }

                // Força a troca da classe
                wrapper.classList.toggle("toggled");

                // Log para você ver no F12 se o clique funcionou
                console.log("Menu alternado. Classe atual:", wrapper.className);
            }

            // Listener Botão Abrir (Hambúrguer)
            if (toggleButton) {
                toggleButton.addEventListener('click', toggleMenu);
            } else {
                console.error("ERRO: Botão #menu-toggle não foi encontrado no HTML!");
            }

            // Listener Botão Fechar (X no mobile)
            if (closeButton) {
                closeButton.addEventListener('click', toggleMenu);
            }

            // Removi a lógica de localStorage por enquanto para evitar confusão no Mobile

            // Dark Mode Toggle (Mantido igual)
            if (themeToggle) {
                // Apply saved theme on load
                const savedTheme = localStorage.getItem('theme');
                const html = document.documentElement;
                if (savedTheme) {
                    html.setAttribute('data-bs-theme', savedTheme);
                    themeToggle.innerHTML = savedTheme === 'light' ? '<i class="bi bi-moon-stars"></i>' : '<i class="bi bi-sun"></i>';
                } else {
                    // Default to light if no theme saved
                    html.setAttribute('data-bs-theme', 'light');
                    themeToggle.innerHTML = '<i class="bi bi-moon-stars"></i>';
                }

                themeToggle.addEventListener('click', () => {
                    const currentTheme = html.getAttribute('data-bs-theme');
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    html.setAttribute('data-bs-theme', newTheme);
                    themeToggle.innerHTML = newTheme === 'light' ? '<i class="bi bi-moon-stars"></i>' : '<i class="bi bi-sun"></i>';
                    localStorage.setItem('theme', newTheme); // Save new theme to localStorage
                });
            }

            // PWA Installation Logic
            let deferredPrompt;
            const installButton = document.getElementById('installButton');

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault(); // Prevent the mini-infobar from appearing
                deferredPrompt = e; // Stash the event so it can be triggered later
                if (installButton) {
                    installButton.classList.remove('d-none'); // Show the install button
                }
            });

            if (installButton) {
                installButton.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt(); // Show the install prompt
                        const { outcome } = await deferredPrompt.userChoice; // Wait for the user to respond to the prompt
                        console.log(`User response to the install prompt: ${outcome}`); // Log the outcome
                        if (outcome === 'accepted') {
                            // User accepted the install prompt
                            installButton.classList.add('d-none'); // Hide the install button if PWA is installed
                        }
                        deferredPrompt = null; // Clear the deferredPrompt
                    }
                });
            }

            // Optional: Hide the install button if the app is already installed
            window.addEventListener('appinstalled', () => {
                if (installButton) {
                    installButton.classList.add('d-none');
                }
            });

            // Register service worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/static/service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }

            // Notification count polling
            {% if current_user.is_authenticated %}
            const notificationBadge = document.getElementById('unread-notifications-badge');

            async function fetchNotificationCount() {
                try {
                    const response = await fetch("{{ url_for('main.unread_notification_count') }}");
                    if (response.ok) {
                        const data = await response.json();
                        if (data.count > 0) {
                            notificationBadge.textContent = data.count;
                            notificationBadge.classList.remove('d-none');
                        } else {
                            notificationBadge.classList.add('d-none');
                        }
                    } else {
                        console.error('Failed to fetch notification count:', response.statusText);
                    }
                } catch (error) {
                    console.error('Error fetching notification count:', error);
                }
            }

            // Fetch on page load
            fetchNotificationCount();
            // Poll every 60 seconds
            setInterval(fetchNotificationCount, 60000); 
            {% endif %}
        });
    </script>
    {% block scripts %}
    {% endblock %}
</body>
</html>
