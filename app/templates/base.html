{% from "macros/pagination_macros.html" import render_pagination %}
<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="light"{% block html_attribs %}{% endblock %}>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="CLAI - Plataforma de Gestão Educacional">
    <meta name="theme-color" content="#0d6efd">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/main.min.css' rel='stylesheet' />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">
    <title>{% if title %}{{ title }} - {% endif %}CLAI | Dashboard</title>
    {% block head_extra %}{% endblock %}
</head>

<body class="d-flex" id="wrapper"{% block body_attribs %}{% endblock %}>
    {% block body %}
    <div id="sidebar-wrapper">
        <div class="sidebar-heading d-flex justify-content-between align-items-center py-4 px-3">
            <div class="fw-bold fs-4 text-primary tracking-tight">
                {{ config.APP_BASE_NAME }}<span class="text-body text-opacity-50">{{ config.APP_SUFFIX }}</span>
            </div>
            <button class="btn btn-link text-secondary" id="sidebar-close">
                <i class="bi bi-x-lg fs-4"></i>
            </button>
        </div>

        <div class="list-group list-group-flush my-3">
            <small class="text-uppercase text-muted fw-bold px-4 mb-2" style="font-size: 0.75rem;">Menu
                Principal</small>

            <a href="{{ url_for('main.dashboard') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.dashboard' %}active{% endif %}">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard
            </a>

            {% if current_user.is_authenticated and current_user.role == 'admin' %}
            <a href="{{ url_for('main.list_users') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.list_users' %}active{% endif %}">
                <i class="bi bi-people me-2"></i>Profissionais
            </a>
            {% endif %}

            <a href="{{ url_for('main.list_students') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.list_students' %}active{% endif %}">
                <i class="bi bi-mortarboard me-2"></i>Alunos
            </a>

            <small class="text-uppercase text-muted fw-bold px-4 mb-2 mt-3"
                style="font-size: 0.75rem;">Ferramentas</small>

            <a href="{{ url_for('main.calendar') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.calendar' %}active{% endif %}">
                <i class="bi bi-calendar4-week me-2"></i>Calendário
            </a>
            <a href="{{ url_for('main.mark_attendance') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.mark_attendance' %}active{% endif %}">
                <i class="bi bi-check-square me-2"></i>Frequência
            </a>
            <a href="{{ url_for('main.generate_report') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.generate_report' %}active{% endif %}">
                <i class="bi bi-graph-up me-2"></i>Relatórios
            </a>
            <a href="{{ url_for('main.list_daily_logs') }}"
                class="list-group-item list-group-item-action {% if request.endpoint == 'main.list_daily_logs' %}active{% endif %}">
                <i class="bi bi-journal-text me-2"></i>Diários
            </a>
        </div>

        <div class="mt-auto p-3 border-top">
            <a href="{{ url_for('main.logout') }}"
                class="d-flex align-items-center text-decoration-none text-danger px-3 py-2 rounded hover-bg-light">
                <i class="bi bi-box-arrow-right me-2"></i>
                <span class="fw-medium">Sair do Sistema</span>
            </a>
        </div>
    </div>
    <div id="page-content-wrapper">
        <nav class="navbar navbar-expand-lg main-navbar px-4">
            <div class="d-flex align-items-center w-100">
                <button class="btn btn-link text-body p-0 me-3" id="menu-toggle">
                    <i class="bi bi-list fs-4"></i>
                </button>

                <h1 class="h5 m-0 fw-semibold text-body">{% block page_heading %}Visão Geral{% endblock %}</h1>

                <div class="ms-auto d-flex align-items-center gap-3">
                    <button class="btn btn-link text-body-secondary p-0" id="theme-toggle" title="Alternar Tema">
                        <i class="bi bi-moon-stars"></i>
                    </button>

                    <div class="dropdown">
                        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                                style="width: 32px; height: 32px;">
                                {% if current_user.is_authenticated %}
                                {{ current_user.name[0] | upper }}
                                {% else %}
                                <i class="bi bi-person"></i> {# Placeholder for unauthenticated user #}
                                {% endif %}
                            </div>
                            <div class="d-none d-md-block">
                                {% if current_user.is_authenticated %}
                                <span class="fw-medium text-body d-block" style="line-height: 1;">{{
                                    current_user.name }}</span>
                                <small class="text-muted" style="font-size: 0.75rem;">{{ current_user.role |
                                    capitalize }}</small>
                                {% else %}
                                <span class="fw-medium text-body d-block" style="line-height: 1;">Convidado</span>
                                <small class="text-muted" style="font-size: 0.75rem;">Não Autenticado</small>
                                {% endif %}
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                            {% if current_user.is_authenticated %}
                            <li><a class="dropdown-item" href="{{ url_for('main.profile') }}"><i
                                        class="bi bi-person-circle me-2"></i>Meu Perfil</a>
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('main.change_password') }}"><i
                                        class="bi bi-key me-2"></i>Alterar Senha</a>
                            </li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Configurações</a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="{{ url_for('main.logout') }}"><i
                                        class="bi bi-box-arrow-right me-2"></i>Sair</a>
                            </li>
                            {% else %}
                            <li><a class="dropdown-item" href="{{ url_for('main.login') }}"><i
                                        class="bi bi-box-arrow-in-right me-2"></i>Entrar</a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="container-fluid mt-3">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <main class="container-fluid px-4 py-4">
            {% block content %}
            <div class="alert alert-light border shadow-sm" role="alert">
                <h4 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Bem-vindo ao CLAI</h4>
                <p class="mb-0 text-muted">Selecione uma opção no menu lateral para começar.</p>
            </div>
            {% endblock %}

            {% block pagination %}
            {% if paginator %}
                {{ render_pagination(paginator) }}
            {% endif %}
            {% endblock %}
        </main>
    </div>
    {% endblock %}

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/locales/pt-br.js'></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const wrapper = document.getElementById("wrapper");
            const toggleButton = document.getElementById("menu-toggle");
            const closeButton = document.getElementById("sidebar-close");
            const themeToggle = document.getElementById("theme-toggle");

            // LOG DE DEBUG: Vamos ver se o JS achou os elementos
            console.log("Wrapper encontrado?", wrapper);
            console.log("Botão Abrir encontrado?", toggleButton);
            console.log("Botão Fechar encontrado?", closeButton);

            function toggleMenu(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation(); // Garante que o clique não "vaze"
                }

                // Força a troca da classe
                wrapper.classList.toggle("toggled");

                // Log para você ver no F12 se o clique funcionou
                console.log("Menu alternado. Classe atual:", wrapper.className);
            }

            // Listener Botão Abrir (Hambúrguer)
            if (toggleButton) {
                toggleButton.addEventListener('click', toggleMenu);
            } else {
                console.error("ERRO: Botão #menu-toggle não foi encontrado no HTML!");
            }

            // Listener Botão Fechar (X no mobile)
            if (closeButton) {
                closeButton.addEventListener('click', toggleMenu);
            }

            // Removi a lógica de localStorage por enquanto para evitar confusão no Mobile

            // Dark Mode Toggle (Mantido igual)
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const html = document.documentElement;
                    const currentTheme = html.getAttribute('data-bs-theme');
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    html.setAttribute('data-bs-theme', newTheme);
                    themeToggle.innerHTML = newTheme === 'light' ? '<i class="bi bi-moon-stars"></i>' : '<i class="bi bi-sun"></i>';
                });
            }
        });
    </script>
    {% block scripts %}
    {% endblock %}
</body>
</html>
